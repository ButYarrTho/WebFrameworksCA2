@using MySql.Data.MySqlClient
<h3>Music</h3>

<!-- Search Section -->
<input type="text" @bind="searchQuery" placeholder="Search for artists..." />
<button @onclick="SearchArtists">Search</button>
<button @onclick="DownloadArtists">Download Top Artists</button>

@if (isLoading)
{
<p>Loading...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
<p style="color: red;">@errorMessage</p>
}
else if (topartists != null && topartists.Results?.ArtistMatches?.Artists?.Length > 0)
{
<ol>
    @foreach (var artist in topartists.Results.ArtistMatches.Artists)
    {
    <li>
        <strong>@artist.Name</strong>
        <p>
            Playcount: @artist.Playcount
            <br />
            <a href="@artist.Url" target="_blank">View on Last.fm</a>
        </p>
        <button @onclick="() => OnSongButtonClicked(artist.Name)">Action</button>
    </li>
    }
</ol>
}
else if (topartists != null && topartists.Topartists?.Artist?.Length > 0)
{
<ol>
    @foreach (var artist in topartists.Topartists.Artist)
    {
    <li>
        <strong>@artist.Name</strong>
        <p>
            Playcount: @artist.Playcount
            <br />
            Rank: @artist.Attr?.Rank
            <br />
            <a href="@artist.Url" target="_blank">View on Last.fm</a>
        </p>
        <button @onclick="() => OnSongButtonClicked(artist.Name)">Action</button>
    </li>
    }
</ol>
}
else
{
<p>No artists found. Try searching or downloading top artists.</p>
}


@code {
    private Artists? topartists;
    private bool isLoading = false;
    private string? errorMessage;
    private string searchQuery = string.Empty;

    private void DownloadArtists()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            topartists = MusicService.GetTopArtists();
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to fetch artists. Please try again.";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

// Search for artists based on the search
    private void SearchArtists()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            errorMessage = "Please enter an artist name to search.";
            topartists = null;  // Ensure that no previous search results are shown
            return;
        }

        isLoading = true;
        errorMessage = null;

        try
        {
            topartists = MusicService.SearchArtists(searchQuery);

            // Check if search results exist
            if (topartists == null || topartists.Results?.ArtistMatches?.Artists == null || topartists.Results.ArtistMatches.Artists.Length == 0)
            {
                errorMessage = "No results found for your search.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to search for artists. Please try again.";
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private void OnSongButtonClicked(string artistName)
    {
        var connectionString = "Server=b4wrtzahdokrnwkdisvz-mysql.services.clever-cloud.com;Database=b4wrtzahdokrnwkdisvz;User=u404013ijbde7adc;Password=VCdtkloWCwNiL29KUOL3;Port=3306;";

        try
        {
            // this connects to db
            using var connection = new MySqlConnection(connectionString);
            connection.Open();

            // this is SQL query
            var insertQuery = @"
            INSERT IGNORE INTO Artists (Name) 
            VALUES (@Name);";
            
            using var insertCommand = new MySqlCommand(insertQuery, connection);

            // associates artist name to query
            insertCommand.Parameters.AddWithValue("@Name", artistName);

            // this pushes the query
            int rowsAffected = insertCommand.ExecuteNonQuery();

            if (rowsAffected > 0)
            {
                Console.WriteLine($"Added new artist: {artistName}");
            }
            else
            {
                Console.WriteLine($"Artist already exists: {artistName}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding artist to the database: {artistName}. Error: {ex.Message}");
        }
    }

}
